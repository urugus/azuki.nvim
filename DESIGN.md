# azuki.nvim 設計方針

## プロジェクト概要

**azuki.nvim** は Neovim内で完結する日本語入力プラグイン。skkeletonのような「Vim操作を邪魔しない」体験を、SKKではなく通常のかな漢字変換で実現する。

名前の由来: azooKeyの音に近い「小豆（あずき）」から。

## 解決する課題

1. **OS IMEの問題** - モード切替がVim操作を中断させる
2. **SKKの学習コスト** - skkeletonは快適だが独特の入力方式に慣れが必要
3. **既存プラグインの不在** - Neovim内で完結する普通のかな漢字変換プラグインがない

## 設計目標

| 優先度 | 目標 |
|--------|------|
| 最高 | 高速な応答（入力のラグを感じさせない） |
| 最高 | azooKey的なライブ変換体験 |
| 高 | Vim操作との自然な共存 |
| 中 | 学習による変換精度向上 |
| 中 | オフラインで動作 |

## サポート対象（当面）

- OS: macOS / Linux を第一ターゲット（Windowsは将来検討）
- 目的: **ユーザー環境でSwift不要**。配布は原則「事前ビルド済みサーババイナリ + 必要データ」で完結させる

## 技術選定

### 変換エンジン: バックエンド差し替え方式（Swift不要）

ユーザー環境の依存を減らすため、**ユーザー環境でSwiftを要求しない**方針とする。よって変換は特定実装に固定せず、サーバ側で「変換バックエンド」を差し替え可能な形で実装する。

**選定理由**
- ライブ変換体験（azooKey由来）
- ローカル完結（ネットワークレイテンシなし）
- 実装・配布を単純化（単一バイナリ + 辞書/データ）
- 将来の精度改善（バックエンド交換・追加）に耐える

**参考**
- fcitx5-hazkey のアーキテクチャ（プロセス分離・IPC）を参考にする

**却下した選択肢**
| 方針 | 却下理由 |
|------|----------|
| ネットワークAPI依存 | レイテンシ、オフライン不可、プライバシ |
| Swift必須 | ユーザー環境依存が増える |

### プラグイン実装: Lua

**選定理由**
- 起動・応答がDenopsより軽量
- Neovimとの親和性が高い
- 外部依存が少ない

**却下した選択肢**
| 言語 | 却下理由 |
|------|----------|
| Denops (TypeScript) | Denoランタイムのオーバーヘッド |

## アーキテクチャ

fcitx5-hazkeyのアーキテクチャを参考に、変換サーバーをプロセス分離する設計。

```
┌─────────────────────────────────────────────────────────┐
│                        Neovim                           │
│  ┌───────────────────────────────────────────────────┐  │
│  │               azuki.nvim (Lua)                    │  │
│  │  - キー入力フック (Insert mode)                   │  │
│  │  - ローマ字→ひらがな変換                          │  │
│  │  - 未確定文字列の表示 (extmark)                   │  │
│  │  - 候補選択UI                                     │  │
│  └──────────────────────┬────────────────────────────┘  │
│                         │ vim.loop (stdin/stdout)       │
└─────────────────────────┼───────────────────────────────┘
                          │ length-prefixed JSON (Protobufは将来)
                          ▼
              ┌───────────────────────────────┐
              │      azuki-server (Rust)      │
              │    (変換バックエンド)          │
              │  - 辞書管理                   │
              │  - かな漢字変換               │
              │  - Zenzai (オプション)        │
              │  - 学習データ保持             │
              └───────────────────────────────┘
```

### プロセス分離の理由

1. **安定性** - 変換エンジンのクラッシュがNeovimに波及しない
2. **辞書プリロード** - サーバー起動時に辞書をメモリ展開
3. **非同期処理** - 変換処理がNeovimのメインループをブロックしない
4. **環境依存の分離** - Neovim本体に特定言語ランタイムを要求しない

### 通信プロトコル

実装の単純さと堅牢性を優先し、**stdio の長さプレフィクス + JSON** を基本とする。

- フレーミング: `u32 (big-endian) length` + `UTF-8 JSON bytes`
- 並行性: リクエストに `seq`（連番）を付け、Lua側は **最新 `seq` 以外の応答を破棄**して体験を安定化
- 将来: 同じフレーミングのまま Protobuf 等に置換できる設計にする

#### メッセージ（最小）

- `init`: サーバ起動直後の初期化（辞書/学習データ/設定ロード）
- `convert`: 未確定かな列（preedit）→ 候補列
- `commit`: 選択候補の確定通知（学習が有効なら反映）
- `shutdown`: 明示終了（基本はnvim終了時）

#### 基本フィールド（案）

- 共通: `type`, `seq`, `session_id`
- `convert`: `reading`（ひらがな全体）, `cursor`（位置）, `context`（前後文は将来）, `options`
- 応答: `candidates`（配列）, `selected_index`, `error`（任意）

#### JSON例（案）

`convert` リクエスト:

```json
{"type":"convert","seq":42,"session_id":"abc","reading":"きょうは","cursor":9,"options":{"live":true}}
```

`convert` レスポンス:

```json
{"type":"convert_result","seq":42,"session_id":"abc","candidates":["今日は","きょうは"],"selected_index":0}
```

`commit` リクエスト（学習用）:

```json
{"type":"commit","seq":43,"session_id":"abc","reading":"きょうは","candidate":"今日は"}
```

## 入力フロー

```
[ユーザー入力]
     │
     ▼ (Insert modeでキーフック)
[ローマ字バッファに蓄積]
     │
     ▼ (ローマ字→ひらがな変換: Lua内で処理)
[ひらがな列]
     │
     ▼ (azuki-serverに送信)
[変換バックエンドで変換]
     │
     ▼
[変換候補をNeovimに返却]
     │
     ▼ (extmarkで表示)
[ライブ変換結果を表示]
     │
     ├─→ [Space/Tab] → 次の候補
     │
     └─→ [Enter/次の入力] → 確定してバッファに挿入
```

## モード設計

### 日本語入力モードの切替

| キー | 動作 |
|------|------|
| `<C-j>` | 日本語入力モード ON/OFF トグル |
| `<Esc>` | 日本語入力モード OFF + Normal mode |

### 変換操作

| キー | 動作 |
|------|------|
| `<Space>` | 変換候補を順に切替 |
| `<S-Space>` | 変換候補を逆順に切替 |
| `<Enter>` | 現在の候補で確定 |
| `<C-g>` | 変換キャンセル（ひらがなに戻す） |
| 次の文字入力 | 自動確定して継続入力 |

## パフォーマンス方針（ライブ変換）

ライブ変換は「毎打鍵で即IPC」ではなく、体感と実装の安定性を優先して以下を基本とする。

- 送信単位: **差分ではなく、未確定かな列（preedit）全体を送る**
- 送信頻度: 通常は **30ms デバウンス**（入力が続く間は後勝ち）
- 即時トリガ: `<Space>`（候補要求/切替）、確定、キャンセル等はデバウンスなしで送信
- 応答競合: `seq` により古い応答を破棄（表示の巻き戻りを防ぐ）

## サーバライフサイクル

- 起動: 日本語入力モードON時に起動（未起動なら自動起動）
- 常駐: セッション中は常駐し辞書を保持（プリロードの効果を最大化）
- 異常系: サーバクラッシュ時はLua側で再起動し、未確定状態は安全側（ひらがなに戻す等）で回復

## 配布・インストール方針（案）

- 既定配置: `vim.fn.stdpath('data') .. '/azuki/bin/azuki-server'` を優先して自動検出
- 明示指定: `server_path` で任意パスを指定可能
- 目標: リリースで **macOS/Linux向けの事前ビルドバイナリ**を配布し、ユーザーがRustを入れなくても動く状態にする

## 表示仕様

### 未確定文字列

- `nvim_buf_set_extmark` の inline virtual text を使用
- 下線付きで表示（未確定であることを視覚的に示す）

### 変換候補

- インライン表示（入力位置に直接表示）
- 複数候補がある場合は選択中の候補をハイライト

## ディレクトリ構成

```
azuki.nvim/
├── lua/
│   └── azuki/
│       ├── init.lua          # エントリーポイント
│       ├── config.lua        # 設定管理
│       ├── romaji.lua        # ローマ字→ひらがな変換
│       ├── server.lua        # azuki-serverとの通信
│       └── ui.lua            # 表示・候補選択
├── server/                   # azuki-server (Rust)
│   ├── Cargo.toml
│   └── src/
│       └── main.rs
├── DESIGN.md                 # 本ドキュメント
└── README.md
```

## 開発フェーズ

### Phase 1: 最小動作確認
- [ ] azuki-server の基本実装（Rust / stdin/stdout 通信）
- [ ] Luaからサーバー起動・通信の確認

### Phase 2: 基本入力機能
- [ ] Insert modeでのキー入力フック
- [ ] ローマ字→ひらがな変換
- [ ] 変換結果のextmark表示
- [ ] 基本的な確定操作

### Phase 3: 変換体験の向上
- [ ] ライブ変換（入力中のリアルタイム変換）
- [ ] 候補選択UI
- [ ] 文節区切りの調整

### Phase 4: 実用化
- [ ] Zenzai統合（ニューラル変換）
- [ ] 学習機能
- [ ] 設定のカスタマイズ
- [ ] パフォーマンス最適化
- [ ] ドキュメント整備

## 設定項目（予定）

```lua
require('azuki').setup({
  -- サーバー設定
  server_path = nil,  -- 自動検出 or 明示指定
  debounce_ms = 30,   -- ライブ変換のデバウンス

  -- 入力設定
  toggle_key = '<C-j>',
  
  -- 変換設定
  live_conversion = true,  -- ライブ変換ON/OFF
  backend = 'auto',        -- 変換バックエンド（将来）
  zenzai = false,          -- ニューラル変換（要追加セットアップ）
  
  -- 表示設定
  highlight = {
    pending = 'AzukiPending',    -- 未確定文字
    selected = 'AzukiSelected',  -- 選択中候補
  },
  
  -- 学習設定
  learning = true,
  learning_file = vim.fn.stdpath('data') .. '/azuki/learning.json',
})
```

## 依存関係

### ユーザー環境
- Neovim >= 0.9.0
- azuki-server（配布バイナリ利用を前提。ソースビルドする場合は Rust toolchain）

### ビルド時
- Rust toolchain（`cargo`）
- 変換バックエンド（採用方式に応じた辞書/モデル/ライブラリ）

## 参考資料

- [fcitx5-hazkey](https://github.com/7ka-Hiira/fcitx5-hazkey) - Linux実装の参考
- [skkeleton](https://github.com/vim-skk/skkeleton) - Neovim IMEプラグインの参考
- [Neovim Lua API](https://neovim.io/doc/user/lua.html) - extmark, vim.loop等
